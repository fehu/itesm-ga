<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Parcial2/Labyrinth.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\documentclass{article}

%include polycode.fmt


\usepackage[utf8]{inputenc}
\usepackage[spanish, mexico]{babel}
\usepackage{amsmath, hyperref, xcolor, tikz, mdframed, subcaption}
\usepackage[shortlabels, inline]{enumitem}

\usetikzlibrary{chains, fit}

% \usepackage{showframe}

\newenvironment{note}
    {\begin{mdframed}[leftmargin=1cm,
                 skipabove=1em,
                 skipbelow=1em,
                 rightline=false,
                 topline=false,
                 bottomline=false,
                 linewidth=2pt]
        \textbf{Nota}\\}
    {\end{mdframed}}


\newcommand{\crule}[2][1pt] {\begin{center}\rule{#2\textwidth}{#1}\end{center}}

\def\github{http://fehu.github.io/itesm-ga/}

\newcommand{\hssrc} [2]{\href{\github/api/src/#1.html}{src/#2}}
\newcommand{\hstest}[2]{\href{\github/api/tests/src/#1.html}{test/#2}}

\newcommand{\resizePicture}[2][\textwidth]{\resizebox{#1}{!}{#2}}}
\newcommand{\resizeInput}[2][\textwidth]{\resizePicture[#1]{\input{#2}}}

\begin{document}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE UndecidableInstances, FlexibleInstances #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Parcial2</span><span class='hs-varop'>.</span><span class='hs-conid'>Labyrinth</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-6"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-layout'>,</span> <span class='hs-varid'>second</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&amp;&amp;&amp;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicateM</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Fix</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-11"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Tuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>swap</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>elemIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>sort</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span><span class='hs-layout'>,</span> <span class='hs-varid'>minimumBy</span><span class='hs-layout'>,</span> <span class='hs-varid'>maximumBy</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromJust</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromMaybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeToList</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span> <span class='hs-layout'>(</span><span class='hs-varid'>xor</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRight</span><span class='hs-layout'>,</span> <span class='hs-conid'>Either</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span> <span class='hs-layout'>(</span><span class='hs-varid'>on</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ratio</span>
<a name="line-18"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-layout'>,</span> <span class='hs-varid'>member</span><span class='hs-layout'>,</span> <span class='hs-varid'>elemAt</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-20"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span> <span class='hs-layout'>(</span><span class='hs-conid'>Down</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>sortWith</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>Parcial2</span><span class='hs-varop'>.</span><span class='hs-conid'>ReadLabyrinth</span>
<a name="line-27"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>GeneticAlgorithm</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Random</span>
</pre>\end{code}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introducción}


El mapa (laberinto), descrito en la tarea, se define como un grafo:
nodos --- un conjunto de puntos (con posiciones correspondientes);
aristas --- la existencia de rutas directas.

\begin{code}
<pre><a name="line-30"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>Labyrinth</span> <span class='hs-varid'>point</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Labyrinth</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>nodes</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>point</span>
<a name="line-31"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>edges</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-varid'>point</span><span class='hs-layout'>,</span> <span class='hs-varid'>point</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>point</span>
<a name="line-33"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>target</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>point</span>
<a name="line-34"></a>                                    <span class='hs-layout'>}</span>
<a name="line-35"></a>        <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a>  <span class='hs-varid'>edgeOf</span> <span class='hs-varid'>p</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`member`</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>swap</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-varid'>mapPoints</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Labyrinth</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>es</span> <span class='hs-varid'>i</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Labyrinth</span> <span class='hs-layout'>{</span>
<a name="line-40"></a>        <span class='hs-varid'>nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ns</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>second</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>target</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span>
<a name="line-44"></a>    <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-varid'>isPOI</span> <span class='hs-varid'>p</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span> <span class='hs-varop'>==</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>l</span> <span class='hs-varop'>||</span> <span class='hs-varid'>p</span> <span class='hs-varop'>==</span> <span class='hs-varid'>target</span> <span class='hs-varid'>l</span>
<a name="line-47"></a>
<a name="line-48"></a>  <span class='hs-varid'>labyrinthPOIs</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>initial</span><span class='hs-layout'>,</span> <span class='hs-varid'>target</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a>
</pre>\end{code}


Se define la \emph{distancia directa} entre los nodos que están conectados por una arista.

\begin{code}
<pre><a name="line-50"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>DirectDistance</span> <span class='hs-varid'>point</span> <span class='hs-varid'>dist</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DirectDistance</span> <span class='hs-layout'>{</span>
<a name="line-51"></a>       <span class='hs-varid'>labyrinthDist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth</span> <span class='hs-varid'>point</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>point</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>point</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>dist</span>
<a name="line-52"></a>      <span class='hs-layout'>}</span>
<a name="line-53"></a>
<a name="line-54"></a>  <span class='hs-varid'>mkDirectDistance</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DirectDistance</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>l</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-55"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>v1</span><span class='hs-layout'>,</span><span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`edgeOf`</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}




\bigskip
\noindent
El algoritmo genético abstracto está definido en \hssrc{GeneticAlgorithm}{GeneticAlgorithm.hs}.
Su implementación se presentará a continuación.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Implementación I}

Misceláneo.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Lectura de mapas}

Se utiliza un mapa 2D:

<pre><a name="line-56"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>newtype</span> <span class='hs-conid'>Point2D</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Point2D</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Point2D</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Point2D</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>"-"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>y</span>
</pre>
<pre><a name="line-59"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>Labyrinth2D</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Labyrinth</span> <span class='hs-conid'>Point2D</span>
</pre>

La lectura del archivo del mapa se encuentra en
\hssrc{Parcial2-ReadLabyrinth}{Parcial2/ReadLabyrinth.hs}.
Aquí se presenta la construcción del grafo a partir del mapa leído.


\begin{code}
<pre><a name="line-60"></a>  <span class='hs-varid'>readLabyrinth2D</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Labyrinth2D</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a>  <span class='hs-varid'>readLabyrinth2D</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>build</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>try</span> <span class='hs-layout'>(</span><span class='hs-varid'>readFile</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-63"></a>    <span class='hs-keyword'>where</span>
<a name="line-64"></a>        <span class='hs-varid'>build</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>displayException</span> <span class='hs-layout'>(</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a>        <span class='hs-varid'>build</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>parseLabyrinth</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>                                   <span class='hs-conid'>Left</span> <span class='hs-varid'>errS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>errS</span>
<a name="line-67"></a>                                   <span class='hs-conid'>Right</span> <span class='hs-varid'>l</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>build'</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-varid'>build'</span> <span class='hs-layout'>(</span><span class='hs-conid'>LabyrinthDescription</span> <span class='hs-varid'>n</span> <span class='hs-varid'>conn</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>coords</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-70"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Point2D</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>coords</span> <span class='hs-varop'>!!</span><span class='hs-layout'>)</span>
<a name="line-71"></a>          <span class='hs-keyword'>in</span> <span class='hs-conid'>Labyrinth</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Point2D</span> <span class='hs-varid'>coords</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-varid'>get</span> <span class='hs-varop'>.</span> <span class='hs-varid'>second</span> <span class='hs-varid'>get</span><span class='hs-layout'>)</span> <span class='hs-varid'>conn</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>get</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-74"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>get</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
</pre>\end{code}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Implementación II}

Se definan las operaciones \emph{atómicas} -- sobre genes y cromosomas,
y los conceptos relacionados.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Adaptación}
\label{subsec:fitness}


El valor de \emph{aptitud de adaptación} se llamará \emph{ruta} y se define
para permitir distinguir fácilmente los dos tipos de rutas
(encodificadas en los cromosomas) posibles:

\begin{itemize}
  \item \textbf{Ruta completa}: es una ruta valida
    ($\exists$ una conexión entre cada par de genes adjuntos) que contiene
    en punto inicial y el punto meta.

    Se caracteriza por la \emph{longitud de la ruta}.

    El resultado, esperado del algoritmo genético es la más corta de estas rutas.

  \item \textbf{Ruta parcial}: es una ruta que
    \begin{enumerate*}[1)]
        \item contiene pares de genes adjuntos, los cuales no están conectados, o
        \item no contiene ambos puntos: inicio y meta.
    \end{enumerate*}

    Se caracteriza por tres valores:
    \begin{enumerate}

        \item \emph{validez} $= \dfrac
            {\text{número de aristas existentes}}
            {\text{número de aristas total}}$;

            \textit{aristas existentes ---
                    aristas que existen entre los pares de genes adjuntos;}

        \item los \emph{puntos de interés} que contiene la ruta;
        \item el número de genes;
        \item la longitud sumatoria de las sub-rutas en el cromosoma.

    \end{enumerate}

\end{itemize}



\begin{code}
<pre><a name="line-76"></a>
<a name="line-77"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>POI</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>POIInit</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>POITarget</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enum</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-78"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>POIs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>POINone</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>POISome</span> <span class='hs-conid'>POI</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>POIBoth</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>POIs</span> <span class='hs-keyword'>where</span>
<a name="line-81"></a>    <span class='hs-varid'>x</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poisIntVal</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>poisIntVal</span> <span class='hs-varid'>y</span>
<a name="line-82"></a>
<a name="line-83"></a>  <span class='hs-varid'>poisIntVal</span> <span class='hs-conid'>POINone</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-84"></a>  <span class='hs-varid'>poisIntVal</span> <span class='hs-layout'>(</span><span class='hs-conid'>POISome</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-85"></a>  <span class='hs-varid'>poisIntVal</span> <span class='hs-conid'>POIBoth</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-86"></a>
<a name="line-87"></a>
<a name="line-88"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>RouteFitness</span> <span class='hs-keyglyph'>=</span>
<a name="line-89"></a>      <span class='hs-conid'>CompleteRoute</span> <span class='hs-layout'>{</span> <span class='hs-varid'>routeLength</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PartialRoute</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>partialValidess</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span>
<a name="line-91"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>partialPOI</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>POIs</span>
<a name="line-92"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>partialPaths</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-93"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>partialLength</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span>
<a name="line-94"></a>                    <span class='hs-layout'>}</span>
<a name="line-95"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
</pre>\end{code}

\noindent Para la busqueda de la ruta mas corta,
se define el orden sobre las rutas de tal manera, que
una lista de \emph{rutas}, ordenada ascendentemente,
tendrá los mejores elementos en el principio.
\begin{enumerate}

  \item Cualquiera \emph{ruta completa} \underline{es menor} que cualquier \emph{ruta parcial}.
        $$\forall x \in \textit{ruta completa},
                  y \in \textit{ruta parcial}     \implies x < y$$

  \item Dos \emph{rutas completas} se comparan por su \underline{longitud} sin cambios en el orden.
        \begin{align*}
            \begin{tabular}{l}
                \forall x \in \textit{ruta completa}, x \sim r_1\\
                \forall y \in \textit{ruta completa}, y \sim r_2
            \end{tabular}
            & \implies
            & \begin{cases}
                x < y & \mbox{si } r_1 < r_2 \\
                x > y & \mbox{si } r_1 > r_2 \\
                x = y & \mbox{en otro caso}
              \end{cases}
        \end{align*}

  \item Dos \emph{rutas parciales} se comparan por los valores,
        producidos desde sus \underline{4 componentes}.
        $ \langle v, i, p, l \rangle \Rightarrow  p \times v \times (\texttt{int } i + 1) - l$


\end{enumerate}

\begin{code}
<pre><a name="line-97"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>RouteFitness</span> <span class='hs-keyword'>where</span>
<a name="line-98"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteRoute</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>CompleteRoute</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-99"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialRoute</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>i1</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialRoute</span> <span class='hs-varid'>v2</span> <span class='hs-varid'>i2</span> <span class='hs-varid'>p2</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-100"></a>        <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>*</span> <span class='hs-varid'>v1</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>poisIntVal</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span>
<a name="line-101"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>p2</span> <span class='hs-varop'>*</span> <span class='hs-varid'>v2</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>poisIntVal</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-102"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteRoute</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-conid'>PartialRoute</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-103"></a>    <span class='hs-varid'>compare</span>  <span class='hs-conid'>PartialRoute</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-layout'>(</span><span class='hs-conid'>CompleteRoute</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-104"></a>
</pre>\end{code}


Función de utilidad: separación de las sub-rutas que se encuentran dentro de un cromosoma.
Separa los puntos de interes como sub-rutas.

\begin{code}
<pre><a name="line-105"></a>  <span class='hs-varid'>splitRoutes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth2D</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Chromosome</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Gene</span> <span class='hs-conid'>GA</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a>  <span class='hs-varid'>splitRoutes</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitRoutes'</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>l</span>
<a name="line-107"></a>
<a name="line-108"></a>  <span class='hs-varid'>splitRoutes'</span> <span class='hs-varid'>accSplit</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>accSplit</span>
<a name="line-109"></a>  <span class='hs-varid'>splitRoutes'</span> <span class='hs-varid'>accSplit</span> <span class='hs-varid'>accRoute</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>accRoute</span><span class='hs-conop'>:</span><span class='hs-varid'>accSplit</span>
<a name="line-110"></a>  <span class='hs-varid'>splitRoutes'</span> <span class='hs-varid'>accSplit</span> <span class='hs-varid'>accRoute</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-111"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>accRoute</span> <span class='hs-keyword'>of</span>
<a name="line-112"></a>        <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>h</span> <span class='hs-varop'>`isPOI`</span> <span class='hs-varid'>l</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>splitRoutes'</span> <span class='hs-layout'>(</span><span class='hs-varid'>addR</span> <span class='hs-varid'>accRoute</span> <span class='hs-varid'>accSplit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>h</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span>
<a name="line-113"></a>        <span class='hs-varid'>prev</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>prev</span> <span class='hs-varop'>`isPOI`</span> <span class='hs-varid'>l</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>splitRoutes'</span> <span class='hs-layout'>(</span><span class='hs-varid'>addR</span> <span class='hs-varid'>accRoute</span> <span class='hs-varid'>accSplit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>h</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span>
<a name="line-114"></a>        <span class='hs-varid'>prev</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>prev</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varop'>`edgeOf`</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>splitRoutes'</span> <span class='hs-varid'>accSplit</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>accRoute</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span>
<a name="line-115"></a>        <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>splitRoutes'</span> <span class='hs-layout'>(</span><span class='hs-varid'>addR</span> <span class='hs-varid'>accRoute</span> <span class='hs-varid'>accSplit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>h</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span>
<a name="line-116"></a>    <span class='hs-keyword'>where</span>   <span class='hs-varid'>addR</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-117"></a>            <span class='hs-varid'>addR</span> <span class='hs-varid'>r</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>s</span>
</pre>\end{code}


La función misma se definirá en subsección \ref{subsec:ga}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Cromosomas aleatorios}
\label{subsec:random}

Un gen aleatorio se selecciona entre todos los nodos del mapa, y se re-genera en caso de
que este gen ya hubiera sido generado previamente.

\begin{code}
<pre><a name="line-118"></a>  <span class='hs-varid'>randPoint</span> <span class='hs-varid'>l</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>first</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemAt`</span> <span class='hs-varid'>nodes</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-119"></a>               <span class='hs-varop'>.</span> <span class='hs-varid'>randomR</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>nodes</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-120"></a>  <span class='hs-varid'>randUnique</span> <span class='hs-varid'>l</span> <span class='hs-varid'>prev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix</span> <span class='hs-varop'>$</span>
<a name="line-121"></a>              <span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-122"></a>               <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>g'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randPoint</span> <span class='hs-varid'>l</span> <span class='hs-varid'>g</span>
<a name="line-123"></a>               <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>prev</span>  <span class='hs-keyword'>then</span> <span class='hs-varid'>f</span> <span class='hs-varid'>g'</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>g'</span><span class='hs-layout'>)</span>
</pre>\end{code}

Se empieza con la generación del primer punto

\begin{code}
<pre><a name="line-124"></a>  <span class='hs-varid'>randChain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StdGen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>  <span class='hs-varid'>randChain</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>g'</span> <span class='hs-varid'>len</span> <span class='hs-varid'>prev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nextRand</span> <span class='hs-varid'>ga</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>first'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>g''</span>
<a name="line-126"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>first'</span><span class='hs-layout'>,</span> <span class='hs-varid'>g''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaLabyri</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-varid'>prev</span> <span class='hs-varid'>g'</span>
</pre>\end{code}

Los demás genes se seleccionan desde los vecinos (los nodos directamente conectados)
del gen previo.

Durante la generación de cadenas se consideran las cadenas, generadas previamente,
para no permitir repeticiones de genes.

Si se encontró una repetición, se intenta
\begin{enumerate*}[1)]
  \item buscar otro vecino, que no se repita;
  \item cambiar la dirección de generación;
  \item buscar a otro vecino, con la nueva dirección.
\end{enumerate*}
En caso que todas las opciones fallen, la cadena se queda de tamaño incompleto.


\begin{code}
<pre><a name="line-127"></a>            <span class='hs-varid'>oneOf</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>first</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>!!</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>randomR</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-128"></a>            <span class='hs-varid'>nextRand</span> <span class='hs-varid'>ga</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nextRand'</span> <span class='hs-varid'>ga</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span>
<a name="line-129"></a>            <span class='hs-varid'>nextRand'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>rev</span> <span class='hs-varid'>c</span> <span class='hs-varid'>chain</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span>
<a name="line-130"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>neighbours</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span> <span class='hs-varop'>`neighboursOf`</span> <span class='hs-varid'>h</span>
<a name="line-131"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>g'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneOf</span> <span class='hs-varid'>neighbours</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StdGen</span><span class='hs-layout'>)</span>
<a name="line-132"></a>                    <span class='hs-varid'>moreTries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>5</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>neighbours</span>
<a name="line-133"></a>                <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>prev</span> <span class='hs-varop'>||</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>chain</span>
<a name="line-134"></a>                 <span class='hs-keyword'>then</span> <span class='hs-comment'>-- connected to some other chain</span>
<a name="line-135"></a>                      <span class='hs-keyword'>if</span> <span class='hs-varid'>moreTries</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>nextRand'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>rev</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>chain</span> <span class='hs-varid'>g'</span> <span class='hs-comment'>-- 1 / 3</span>
<a name="line-136"></a>                                   <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rev</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>chain</span> <span class='hs-comment'>-- incomplete</span>
<a name="line-137"></a>                                               <span class='hs-keyword'>else</span> <span class='hs-varid'>nextRand'</span> <span class='hs-varid'>ga</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>chain</span> <span class='hs-varid'>g'</span> <span class='hs-comment'>-- 2</span>
<a name="line-138"></a>                 <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>length</span> <span class='hs-varid'>chain</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>len</span>
<a name="line-139"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>chain</span> <span class='hs-comment'>-- return</span>
<a name="line-140"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>nextRand'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>rev</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>chain</span><span class='hs-layout'>)</span> <span class='hs-varid'>g'</span> <span class='hs-comment'>-- next</span>
</pre>\end{code}


\noindent La generación de cromosoma completa se presentará en subsección \ref{subsec:ga}.

\crule{0.75}

\begin{figure}
    \centering
    \input{MapExampleRaw.tikz}
    \caption{Ejemplo de mapa, inicio: 0--2, meta: 9--3.}
    \label{fig:rawMapExample}
\end{figure}

\begin{figure}
    \centering
    \input{MapExampleChromosomes.tikz}
    \caption{Se presentan algunos cromosomas en el mapa.
             Los cromosomas {\color{orange} •} {\color{blue} •} {\color{green} •} están compuestas
               de pares de genes, conectados por aristas;
             mientras que los cromosomas {\color{red} •} {\color{violet} •} están compuestos
               de cadenas de genes, conectados por aristas, de longitud 3.
            \textit{\small (Son de diferente grosor para que se ven mejor
                            las conexiones que existen en varios cromosomas)}
            }
    \label{fig:chromosomesMapExample}
\end{figure}


\noindent Para mejorar las poblaciones iniciales, las cromosomas se componen de \emph{cadenas}
-- secuencias de genes, que son sub-rutas validas de tamaños diferentes.

En la figura \ref{fig:rawMapExample} se presenta el ejemplo de un mapa y
en la figura \ref{fig:chromosomesMapExample} se presenta un ejemplo de cromosomas generados.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Sub-Rutas}
\label{subsec:subroutes}

Se definen los contenedores de sub-rutas. Se guardan solamente los genes extremos de la ruta
y se proveen funciones de búsqueda de sub-ruta en el cromosoma. Se implementa así porque los
cromosomas cambian durante operaciones genéticas, afectando las sub-rutas.

El orden sobre las sub-rutas se define en contexto de dos cromosomas: donador y receptor.
Se comparan lexográficamente los siguientes valores:
\begin{enumerate}
  \item Número de puntos de interés que tiene el donador pero no el receptor.
  \item Diferencia entre las longitudes de donador y receptor.
\end{enumerate}


\begin{code}
<pre><a name="line-141"></a>
<a name="line-142"></a>  <span class='hs-keyword'>newtype</span> <span class='hs-conid'>SubRoute</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubRoute</span> <span class='hs-layout'>(</span><span class='hs-conid'>Point2D</span><span class='hs-layout'>,</span> <span class='hs-conid'>Point2D</span><span class='hs-layout'>)</span>
<a name="line-143"></a>        <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-144"></a>
<a name="line-145"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>SubRoute</span> <span class='hs-keyword'>where</span>
<a name="line-146"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>SubRoute</span> <span class='hs-varid'>p1</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoute</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>p2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>swap</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>p2</span>
<a name="line-147"></a>
<a name="line-148"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Reversed</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>
<a name="line-149"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Reversed</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a>  <span class='hs-varid'>subseq</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>to</span> <span class='hs-comment'>-</span> <span class='hs-varid'>from</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>from</span>
<a name="line-152"></a>
<a name="line-153"></a>  <span class='hs-varid'>findSubRoute</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubRoute</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SubRoutePoints</span>
<a name="line-154"></a>  <span class='hs-varid'>findSubRoute</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoute</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>route</span> <span class='hs-keyglyph'>=</span>
<a name="line-155"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>elemIndex</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>elemIndex</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-varid'>route</span> <span class='hs-keyword'>of</span>
<a name="line-156"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>yi</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-keyword'>let</span>     <span class='hs-varid'>rev</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>yi</span>
<a name="line-157"></a>                                                <span class='hs-varid'>ids'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>yi</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                                                <span class='hs-varid'>ids</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rev</span>    <span class='hs-keyword'>then</span> <span class='hs-varid'>swap</span> <span class='hs-varid'>ids'</span>
<a name="line-159"></a>                                                                    <span class='hs-keyword'>else</span> <span class='hs-varid'>ids'</span>
<a name="line-160"></a>                                        <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>subseq</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>route</span><span class='hs-layout'>,</span> <span class='hs-varid'>rev</span><span class='hs-layout'>)</span>
<a name="line-161"></a>                <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-162"></a>
<a name="line-163"></a>  <span class='hs-comment'>-- Sub-routes, found in 2 points sequences.</span>
<a name="line-164"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>SubRoutes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubRoutes</span>    <span class='hs-conid'>Labyrinth2D</span>
<a name="line-165"></a>                                <span class='hs-conid'>SubRoute</span>
<a name="line-166"></a>                                <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-conid'>SubRoutePoints</span><span class='hs-layout'>)</span>
<a name="line-167"></a>                                <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-conid'>SubRoutePoints</span><span class='hs-layout'>)</span>
<a name="line-168"></a>        <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-169"></a>
<a name="line-170"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>where</span>
<a name="line-171"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-varop'>==</span>  <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-172"></a>      <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>sr1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-varop'>==</span>  <span class='hs-varid'>r</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>sr2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span>
<a name="line-173"></a>                <span class='hs-varid'>l1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>l2</span>
<a name="line-174"></a>            <span class='hs-varop'>&amp;&amp;</span>  <span class='hs-varid'>sr1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sr2</span>
<a name="line-175"></a>            <span class='hs-varop'>&amp;&amp;</span>  <span class='hs-varid'>same</span> <span class='hs-varid'>subRouteDonor</span>
<a name="line-176"></a>            <span class='hs-varop'>&amp;&amp;</span>  <span class='hs-varid'>same</span> <span class='hs-varid'>subRouteReceiver</span>
<a name="line-177"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>same</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r</span>
<a name="line-178"></a>
<a name="line-179"></a>  <span class='hs-varid'>subRouteDonor</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>donor</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>donor</span> <span class='hs-keyword'>of</span>     <span class='hs-conid'>Left</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-180"></a>                                                                <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-181"></a>
<a name="line-182"></a>  <span class='hs-varid'>subRouteReceiver</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>recei</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>recei</span> <span class='hs-keyword'>of</span>     <span class='hs-conid'>Left</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-183"></a>                                                                <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-184"></a>
<a name="line-185"></a>  <span class='hs-varid'>subRoutesBoth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subRouteDonor</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>subRouteReceiver</span>
<a name="line-186"></a>
<a name="line-187"></a>  <span class='hs-varid'>subRoutesLabyrinth</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-188"></a>
<a name="line-189"></a>  <span class='hs-varid'>subRoutesPts</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pts</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pts</span>
<a name="line-190"></a>
<a name="line-191"></a>  <span class='hs-varid'>lPairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lPairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  <span class='hs-varid'>lPairs</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-193"></a>
<a name="line-194"></a>  <span class='hs-varid'>subRoutesIn</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth2D</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubRoute</span>
<a name="line-195"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubRoutes</span><span class='hs-keyglyph'>]</span>
<a name="line-196"></a>  <span class='hs-varid'>subRoutesIn</span> <span class='hs-varid'>l</span> <span class='hs-varid'>subRoute</span> <span class='hs-varid'>pts1</span> <span class='hs-varid'>pts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-197"></a>        <span class='hs-varid'>route1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findSubRoute</span> <span class='hs-varid'>subRoute</span> <span class='hs-varid'>pts1</span>
<a name="line-198"></a>        <span class='hs-varid'>route2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findSubRoute</span> <span class='hs-varid'>subRoute</span> <span class='hs-varid'>pts2</span>
<a name="line-199"></a>
<a name="line-200"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>valid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`edgeOf`</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lPairs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span>
<a name="line-201"></a>            <span class='hs-varid'>sRoutes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l</span> <span class='hs-varid'>subRoute</span>
<a name="line-202"></a>            <span class='hs-varid'>r1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>route1</span>
<a name="line-203"></a>            <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>route2</span>
<a name="line-204"></a>            <span class='hs-varid'>sRoutesLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sRoutes</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
<a name="line-205"></a>            <span class='hs-varid'>sRoutesRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sRoutes</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>r1</span>
<a name="line-206"></a>
<a name="line-207"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>valid</span> <span class='hs-varid'>route1</span><span class='hs-layout'>,</span> <span class='hs-varid'>valid</span> <span class='hs-varid'>route2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-208"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sRoutesLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>sRoutesRight</span><span class='hs-keyglyph'>]</span>
<a name="line-209"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>sRoutesLeft</span>
<a name="line-210"></a>                <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>sRoutesRight</span>
<a name="line-211"></a>                <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-212"></a>
<a name="line-213"></a>
<a name="line-214"></a>  <span class='hs-varid'>subRoutesValue</span> <span class='hs-varid'>sr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pois</span><span class='hs-layout'>,</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span>
<a name="line-215"></a>    <span class='hs-keyword'>where</span>   <span class='hs-varid'>donor</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subRouteDonor</span> <span class='hs-varid'>sr</span>
<a name="line-216"></a>            <span class='hs-varid'>receiver</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subRouteReceiver</span> <span class='hs-varid'>sr</span>
<a name="line-217"></a>            <span class='hs-varid'>countPois</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`isPOI`</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-218"></a>            <span class='hs-varid'>pois</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>countPois</span> <span class='hs-varid'>donor</span> <span class='hs-comment'>-</span> <span class='hs-varid'>countPois</span> <span class='hs-varid'>receiver</span>
<a name="line-219"></a>            <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>receiver</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>donor</span>
<a name="line-220"></a>
<a name="line-221"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>SubRoutes</span> <span class='hs-keyword'>where</span> <span class='hs-varid'>compare</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>subRoutesValue</span>
<a name="line-222"></a>
</pre>\end{code}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Recombinación de cromosomas}
\label{subsec:crossover}

Aquí solamente se define la recombinación de dos cromosomas, su selección
será descrita en la subsección \ref{subsec:gaSelect}.


\subsubsection{Remplazamiento}

Se remplazan los ``hoyos'' de la siguiente manera:

\begin{enumerate}
\item Se seleccionan los genes $\lbrace c \rbrace$, miembros de ambos cromosomas.

\item Para ambos cromosomas se encuentran \emph{sub-rutas intercambiables}:
      \begin{align*}
        \forall ~&x \in \lbrace c \rbrace \\
                 &y \in \lbrace c \rbrace \quad \implies \\
                 &
        \begin{cases}
            \text{secuencia } \lbrace r_i \rbrace_{i=1}^{N_r}
                & \mbox{si } \begin{aligned}
                    \forall &~r_{j-1}, r_j \in \lbrace r_i \rbrace_{i=1}^{N_r} \\
                    \exists & \text{ arista entre } r_{j-1} \text{ y } r_j
                  \end{alaigned} \\
                \lbrace\rbrace & \mbox{en otro caso}
        \end{cases}
      \end{align*}

      Se guarda también la dirección de las sub-rutas para ambos cromosomas.

\item Se aplica el remplazamiento para todas las rutas intercambiables ordenadas
        (fue descrito en la subsección \ref{subsec:subroutes}).
      Se remplazan las sub-rutas no existentes por las existentes;
      y se remplazan las existentes por otras mas cortas.

      El remplazamiento se aplica solamente si
      \begin{enumerate*}[1)]
        \item los genes en cuestión no fueron eliminados con los remplazamientos previos;
        \item remplazamiento no creará genes duplicados;
        \item no disminuye el número de puntos de interés.
      \end{enumerate*}

 \item Se devuelve el par de cromosomas remplazados.

\end{enumerate}

\subsubsection{Extensión de extremos}

Se extienden los extremos del receptor con los del donador:
\begin{enumerate}
\item Se encuentran los extremos mas cortos del donador: entre todos los
  puntos $\left{ c \right}$ se seleccionan los de menor y
  mayor índices en el cromosoma donador. Si las sub-rutas entre los
  puntos extremos y los índices correspondientes son \emph{validas} -- se guardan.
\item Se encuentran los extremos, correspondientes a los puntos, seleccionados en
  el punto previo. Se guardan si son \emph{invalidas}.
\item Se remplazan los extremos correspondientes del receptor por los
  del donador (si fueron guardados ambos).
\end{enumerate}


\crule{1}

\noindent  Se definen algunas funciones de utilidad; la definición de `'crossover'' se encuentra en
    la subsección \ref{subsec:ga}.

\begin{code}
<pre><a name="line-223"></a>  <span class='hs-varid'>replaceList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-224"></a>  <span class='hs-varid'>replaceList</span> <span class='hs-varid'>what</span> <span class='hs-varid'>with</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-225"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span>  <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>what</span> <span class='hs-varop'>`elemIndex`</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;&amp;</span>
<a name="line-226"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>what</span> <span class='hs-varop'>`elemIndex`</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span>
<a name="line-227"></a>          <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ids</span> <span class='hs-keyword'>of</span>
<a name="line-228"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>il</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ir</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-229"></a>                     <span class='hs-keyword'>let</span>  <span class='hs-layout'>(</span><span class='hs-varid'>left</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>il</span> <span class='hs-varid'>l</span>
<a name="line-230"></a>                          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>right</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ir</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span>
<a name="line-231"></a>                     <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>left</span> <span class='hs-varop'>++</span> <span class='hs-varid'>with</span> <span class='hs-varop'>++</span> <span class='hs-varid'>right</span>
<a name="line-232"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-233"></a>
</pre>\end{code}
\begin{code}
<pre><a name="line-234"></a>
<a name="line-235"></a>  <span class='hs-varid'>replaceSafe</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth2D</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-236"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-237"></a>  <span class='hs-varid'>replaceSafe</span> <span class='hs-varid'>lab</span> <span class='hs-varid'>what</span> <span class='hs-varid'>with</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-238"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>candidate</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replaceList</span> <span class='hs-varid'>what</span> <span class='hs-varid'>with</span> <span class='hs-varid'>l</span>
<a name="line-239"></a>              <span class='hs-varid'>poisTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`isPOI`</span> <span class='hs-varid'>lab</span><span class='hs-layout'>)</span> <span class='hs-varid'>what</span>
<a name="line-240"></a>              <span class='hs-varid'>poisSrc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`isPOI`</span> <span class='hs-varid'>lab</span><span class='hs-layout'>)</span> <span class='hs-varid'>with</span>
<a name="line-241"></a>          <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidate</span>
<a name="line-242"></a>                 <span class='hs-keyword'>if</span> <span class='hs-varid'>poisSrc</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>poisTarget</span> <span class='hs-varop'>||</span> <span class='hs-varid'>c</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>c</span>
<a name="line-243"></a>                 <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c</span>
<a name="line-244"></a>
</pre>\end{code}
\begin{code}
<pre><a name="line-245"></a>
<a name="line-246"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>ReplaceDebug</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>SubRoutes</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-247"></a>
<a name="line-248"></a>  <span class='hs-varid'>tryReplace</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-249"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-250"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-conid'>SubRoutePoints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubRoutePoints</span><span class='hs-layout'>)</span>
<a name="line-251"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubRoutes</span><span class='hs-keyglyph'>]</span>
<a name="line-252"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReplaceDebug</span>
<a name="line-253"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ReplaceDebug</span><span class='hs-layout'>)</span>
<a name="line-254"></a>  <span class='hs-varid'>tryReplace</span> <span class='hs-varid'>chrom</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>debugAcc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>chrom</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugAcc</span><span class='hs-layout'>)</span>
<a name="line-255"></a>  <span class='hs-varid'>tryReplace</span> <span class='hs-varid'>chrom</span> <span class='hs-varid'>thisSide</span> <span class='hs-varid'>getThatSide</span> <span class='hs-layout'>(</span><span class='hs-varid'>sr</span><span class='hs-conop'>:</span><span class='hs-varid'>srs</span><span class='hs-layout'>)</span> <span class='hs-varid'>debugAcc</span> <span class='hs-keyglyph'>=</span>
<a name="line-256"></a>      <span class='hs-varid'>tryReplace</span> <span class='hs-varid'>res</span> <span class='hs-varid'>thisSide</span> <span class='hs-varid'>getThatSide</span> <span class='hs-varid'>srs</span> <span class='hs-varid'>acc'</span>
<a name="line-257"></a>      <span class='hs-keyword'>where</span>  <span class='hs-varid'>acc'</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>mbRes</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>chrom</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>debugAcc</span>
<a name="line-258"></a>                     <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>debug</span><span class='hs-layout'>,</span><span class='hs-varid'>mbRes</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>debugAcc</span>
<a name="line-259"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mbRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>debug</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>chrom</span><span class='hs-layout'>,</span> <span class='hs-varid'>sr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res'</span>
<a name="line-260"></a>             <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>chrom</span> <span class='hs-varid'>mbRes</span>
<a name="line-261"></a>             <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sr</span> <span class='hs-keyword'>of</span>
<a name="line-262"></a>               <span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l</span> <span class='hs-varid'>pts</span> <span class='hs-varid'>src'</span> <span class='hs-varid'>target'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>thisSide</span> <span class='hs-varid'>target'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-263"></a>                      <span class='hs-keyword'>do</span>  <span class='hs-varid'>target</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSubRoute</span> <span class='hs-varid'>pts</span> <span class='hs-varid'>chrom</span>
<a name="line-264"></a>                          <span class='hs-keyword'>let</span>  <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getThatSide</span> <span class='hs-varid'>src'</span>
<a name="line-265"></a>                               <span class='hs-varid'>rev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>src</span> <span class='hs-varop'>`xor`</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>target</span>
<a name="line-266"></a>
<a name="line-267"></a>                               <span class='hs-varid'>debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubRoutes</span> <span class='hs-varid'>l</span> <span class='hs-varid'>pts</span>
<a name="line-268"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-varid'>src'</span><span class='hs-layout'>)</span>
<a name="line-269"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span> <span class='hs-varid'>target'</span><span class='hs-layout'>)</span>
<a name="line-270"></a>
<a name="line-271"></a>                          <span class='hs-varid'>return</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>replaceSafe</span> <span class='hs-varid'>l</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span>
<a name="line-272"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
<a name="line-273"></a>                                                   <span class='hs-varid'>chrom</span>
<a name="line-274"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>debug</span> <span class='hs-layout'>)</span>
<a name="line-275"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-276"></a>
</pre>\end{code}
\begin{code}
<pre><a name="line-277"></a>
<a name="line-278"></a>  <span class='hs-varid'>samePoints</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>  <span class='hs-varid'>set1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>x</span>
<a name="line-279"></a>                        <span class='hs-varid'>set2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>y</span>
<a name="line-280"></a>                  <span class='hs-keyword'>in</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span>  <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>intersection</span> <span class='hs-varid'>set1</span> <span class='hs-varid'>set2</span>
<a name="line-281"></a>
<a name="line-282"></a>
<a name="line-283"></a>
<a name="line-284"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>ExtendDebug'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-285"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>ExtendDebug</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendDebug'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExtendDebug'</span><span class='hs-layout'>)</span>
<a name="line-286"></a>
<a name="line-287"></a>  <span class='hs-varid'>tryExtend</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth2D</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-288"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExtendDebug'</span><span class='hs-layout'>)</span>
<a name="line-289"></a>  <span class='hs-varid'>tryExtend</span> <span class='hs-varid'>l</span> <span class='hs-varid'>donor</span> <span class='hs-varid'>receiver</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>deb</span><span class='hs-layout'>)</span>
<a name="line-290"></a>    <span class='hs-keyword'>where</span>  <span class='hs-varid'>cmp</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemIndex`</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-291"></a>           <span class='hs-varid'>valid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`edgeOf`</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lPairs</span>
<a name="line-292"></a>           <span class='hs-varid'>inCase</span> <span class='hs-varid'>x</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>c</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-293"></a>
<a name="line-294"></a>           <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>samePoints</span> <span class='hs-varid'>donor</span> <span class='hs-varid'>receiver</span>
<a name="line-295"></a>
<a name="line-296"></a>
<a name="line-297"></a>           <span class='hs-varid'>left</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minimumBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmp</span> <span class='hs-varid'>donor</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-298"></a>           <span class='hs-varid'>right</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximumBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmp</span> <span class='hs-varid'>donor</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-299"></a>
<a name="line-300"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>diLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>left</span> <span class='hs-varop'>`elemIndex`</span> <span class='hs-varid'>donor</span>
<a name="line-301"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>diRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>right</span> <span class='hs-varop'>`elemIndex`</span> <span class='hs-varid'>donor</span>
<a name="line-302"></a>
<a name="line-303"></a>           <span class='hs-varid'>drLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subseq</span> <span class='hs-num'>0</span> <span class='hs-varid'>diLeft</span> <span class='hs-varid'>donor</span>
<a name="line-304"></a>           <span class='hs-varid'>drRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subseq</span> <span class='hs-varid'>diRight</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>donor</span> <span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>donor</span>
<a name="line-305"></a>
<a name="line-306"></a>           <span class='hs-varid'>mbdRLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drLeft</span> <span class='hs-varop'>`inCase`</span> <span class='hs-varid'>valid</span>
<a name="line-307"></a>           <span class='hs-varid'>mbdRRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drRight</span> <span class='hs-varop'>`inCase`</span> <span class='hs-varid'>valid</span>
<a name="line-308"></a>
<a name="line-309"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>riLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>left</span> <span class='hs-varop'>`elemIndex`</span> <span class='hs-varid'>receiver</span>
<a name="line-310"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>riRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>right</span> <span class='hs-varop'>`elemIndex`</span> <span class='hs-varid'>receiver</span>
<a name="line-311"></a>
<a name="line-312"></a>           <span class='hs-varid'>rrLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subseq</span> <span class='hs-num'>0</span> <span class='hs-varid'>riLeft</span> <span class='hs-varid'>receiver</span>
<a name="line-313"></a>           <span class='hs-varid'>rrRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subseq</span> <span class='hs-varid'>riRight</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>receiver</span> <span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>receiver</span>
<a name="line-314"></a>
<a name="line-315"></a>           <span class='hs-varid'>mbrRLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rrLeft</span> <span class='hs-varop'>`inCase`</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>valid</span><span class='hs-layout'>)</span>
<a name="line-316"></a>           <span class='hs-varid'>mbrRRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rrRight</span> <span class='hs-varop'>`inCase`</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>valid</span><span class='hs-layout'>)</span>
<a name="line-317"></a>
<a name="line-318"></a>           <span class='hs-varid'>extend</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span> <span class='hs-varid'>chrom</span> <span class='hs-keyglyph'>=</span>
<a name="line-319"></a>                <span class='hs-varid'>replaceSafe</span> <span class='hs-varid'>l</span> <span class='hs-varid'>target</span> <span class='hs-varid'>src</span> <span class='hs-varid'>chrom</span>
<a name="line-320"></a>           <span class='hs-varid'>extend</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-321"></a>
<a name="line-322"></a>           <span class='hs-varid'>extLeft</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>mbdRLeft</span> <span class='hs-varid'>mbrRLeft</span> <span class='hs-varid'>receiver</span>
<a name="line-323"></a>           <span class='hs-varid'>extRight</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>mbdRLeft</span> <span class='hs-varid'>mbrRLeft</span>
<a name="line-324"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>receiver</span> <span class='hs-varid'>extLeft</span>
<a name="line-325"></a>
<a name="line-326"></a>           <span class='hs-varid'>debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>extRight</span><span class='hs-layout'>)</span>
<a name="line-327"></a>           <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span><span class='hs-varid'>receiver</span> <span class='hs-varop'>`fromMaybe`</span> <span class='hs-varid'>extLeft</span><span class='hs-layout'>)</span>
<a name="line-328"></a>                     <span class='hs-varop'>`fromMaybe`</span> <span class='hs-varid'>extRight</span>
<a name="line-329"></a>
<a name="line-330"></a>           <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>receiver</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>result</span>
<a name="line-331"></a>           <span class='hs-varid'>deb</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cs</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>debug</span>
<a name="line-332"></a>
</pre>\end{code}


\begin{figure}
\centering
\caption{ Recombinación de cromosomas, marcados {\color{violet} •} y {\color{orange} •}
          en la figura \ref{fig:chromosomesMapExample}.
        }

  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletOrangeSources.tikz} }
    \caption{ Los remplazamientos. }
    \label{fig:crossVOsrc}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletOrangeRoute0.tikz} }
    \caption{ Remplazamiento {\color{orange} •} $\rightarrow$ {\color{violet} •} \#1. }
    \label{fig:crossVOr0}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletOrangeRoute1.tikz} }
    \caption{ Remplazamiento {\color{violet} •} $\rightarrow$ {\color{orange} •}. }
    \label{fig:crossVOr1}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletOrangeRoute2.tikz} }
    \caption{ Remplazamiento {\color{orange} •} $\rightarrow$ {\color{violet} •} \#2. }
    \label{fig:crossVOr2}
  \end{subfigure}

\label{fig:crossVO}
\end{figure}


\begin{figure}
\centering
\begin{subfigure}[b]{\textwidth}
    \input{CrossoverVioletOrangeChildrenFst.tikz }
    \caption{ Resultados de recombinación de sub-rutas en cromosoma {\color{violet} •} desde
              {\color{orange} •}.
            }
    \label{fig:crossOVchildren}
\end{subfigure}
\\
\begin{subfigure}[b]{\textwidth}
    \input{CrossoverVioletOrangeChildrenSnd.tikz }
    \caption{ Resultados de recombinación de sub-rutas en cromosoma {\color{orange} •} desde
              {\color{violet} •}.
            }
    \label{fig:crossVOchildren}
\end{subfigure}

\caption{}
\end{figure}


\begin{figure}
\centering
\caption{ Recombinación de cromosomas, marcados {\color{violet} •} y {\color{blue} •}
          en la figura \ref{fig:chromosomesMapExample}.
        }

  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueSources.tikz} }
    \caption{ Los remplazamientos. }
    \label{fig:crossVBsrc}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute0.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr0}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute1.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr1}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute2.tikz} }
    \caption{ Remplazamiento {\color{violet} •} $\rightarrow$ {\color{blue} •}. }
    \label{fig:crossVBr2}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute3.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr3}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute4.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr4}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute5.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr5}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute6.tikz} }
    \caption{ Remplazamiento {\color{violet} •} $\rightarrow$ {\color{blue} •}. }
    \label{fig:crossVBr6}
  \end{subfigure}
\\
  \begin{subfigure}[b]{\textwidth}
    \fbox{ \resizeInput{CrossoverVioletBlueRoute7.tikz} }
    \caption{ Remplazamiento {\color{blue} •} $\rightarrow$ {\color{violet} •}. }
    \label{fig:crossVBr7}
  \end{subfigure}

\label{fig:crossVB}
\end{figure}


\begin{figure}
\centering
\begin{subfigure}[b]{\textwidth}
    \input{CrossoverVioletBlueChildrenFst.tikz }
    \caption{ Resultados de recombinación de sub-rutas en cromosoma {\color{blue} •} desde
              {\color{violet} •}.
            }
    \label{fig:crossVBchildren}
\end{subfigure}
\\
\begin{subfigure}[b]{\textwidth}
    \input{CrossoverVioletBlueChildrenSnd.tikz }
    \caption{ Resultados de recombinación de sub-rutas en cromosoma {\color{violet} •} desde
              {\color{blue} •}.
            }
    \label{fig:crossBVchildren}
\end{subfigure}

\caption{}
\end{figure}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Mutación de cromosomas}
\label{subsec:mutation}


La mutación de cromosomas consiste de varias operaciones,
que se dividen en las que cambian un gen o una sub-ruta.

\begin{code}
<pre><a name="line-333"></a>
<a name="line-334"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>MutateSubRoute</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-335"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>MutateGene</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Point2D</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Point2D</span>
<a name="line-336"></a>
<a name="line-337"></a>
<a name="line-338"></a>  <span class='hs-comment'>-- Choose randomly an element from a list.</span>
<a name="line-339"></a>  <span class='hs-varid'>randChoice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>randChoice'</span>
<a name="line-340"></a>  <span class='hs-varid'>randChoice'</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomRIO</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-341"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>!!</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ind</span>
<a name="line-342"></a>
<a name="line-343"></a>  <span class='hs-varid'>randChoiceSafe</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-344"></a>  <span class='hs-varid'>randChoiceSafe</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>randChoice</span> <span class='hs-varid'>xs</span>
<a name="line-345"></a>
<a name="line-346"></a>  <span class='hs-varid'>randRange</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-347"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>i1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randChoice'</span> <span class='hs-varid'>xs</span>
<a name="line-348"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randChoice'</span> <span class='hs-varid'>xs</span>
<a name="line-349"></a>
<a name="line-350"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>i1</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i1</span><span class='hs-layout'>)</span>
<a name="line-351"></a>
</pre>\end{code}

Se definen las siguientes \emph{operaciones sobre sub-rutas}: {\color{red} \Large desactivadas}
\begin{itemize}
  \item Cambia una sub-ruta valida por otra aleatoria (valida),
        con misma longitud.

\begin{code}
<pre><a name="line-352"></a>  <span class='hs-varid'>mutSubRouteSame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutateSubRoute</span>
<a name="line-353"></a>  <span class='hs-varid'>mutSubRouteSame</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>ch</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-354"></a>      <span class='hs-varid'>print</span> <span class='hs-str'>"mutSubRouteSame"</span>
<a name="line-355"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>srs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitRoutes</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaLabyri</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-varid'>ch</span>
<a name="line-356"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>sr</span><span class='hs-layout'>,</span> <span class='hs-varid'>sri</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randChoice'</span> <span class='hs-varid'>srs</span>
<a name="line-357"></a>      <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStdGen</span>
<a name="line-358"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>sr</span>
<a name="line-359"></a>          <span class='hs-varid'>rChain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randChain</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>gen</span> <span class='hs-varid'>len</span> <span class='hs-conid'>[]</span>
<a name="line-360"></a>
<a name="line-361"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>concat</span>  <span class='hs-varop'>$</span>   <span class='hs-varid'>subseq</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>sri</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>srs</span>
<a name="line-362"></a>                       <span class='hs-varop'>++</span>  <span class='hs-varid'>rChain</span>
<a name="line-363"></a>                       <span class='hs-conop'>:</span>   <span class='hs-varid'>subseq</span> <span class='hs-layout'>(</span><span class='hs-varid'>sri</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>len</span> <span class='hs-varid'>srs</span>
</pre>\end{code}

  \item Cambia una sub-ruta, aleatoriamente seleccionada, por otra(s) aleatoria(s).

\begin{code}
<pre><a name="line-364"></a>  <span class='hs-varid'>mutSubRouteAny</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutateSubRoute</span>
<a name="line-365"></a>  <span class='hs-varid'>mutSubRouteAny</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>ch</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-366"></a>    <span class='hs-varid'>print</span> <span class='hs-str'>"mutSubRouteAny"</span>
<a name="line-367"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>maxGen</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gaMutateMaxChainsGen</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gaParams</span> <span class='hs-varid'>ga</span>
<a name="line-368"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>maxLen</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gaMutateMaxChainLen</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gaParams</span> <span class='hs-varid'>ga</span>
<a name="line-369"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomRIO</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxGen</span><span class='hs-layout'>)</span>
<a name="line-370"></a>
<a name="line-371"></a>    <span class='hs-varid'>cut</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>subseq</span><span class='hs-layout'>)</span> <span class='hs-varid'>ch</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>randRange</span> <span class='hs-varid'>ch</span>
<a name="line-372"></a>
<a name="line-373"></a>    <span class='hs-varid'>paste</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-374"></a>                            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>len</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomRIO</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxLen</span><span class='hs-layout'>)</span>
<a name="line-375"></a>                                         <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStdGen</span>
<a name="line-376"></a>                                         <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>randChain</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>gen</span> <span class='hs-varid'>len</span> <span class='hs-conid'>[]</span>
<a name="line-377"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromJust</span> <span class='hs-varop'>$</span> <span class='hs-varid'>replaceList</span> <span class='hs-varid'>cut</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>paste</span><span class='hs-layout'>)</span> <span class='hs-varid'>ch</span>
<a name="line-378"></a>
</pre>\end{code}

\end{itemize}

Se definen las siguientes \emph{operaciones sobre genes} con la probabilidad de aplicación:
\begin{itemize}[leftmargin=2.5cm]
  \item[$P=0.01$ ---] Cambia un gen a un de los puntos de interés (inicio/meta),
    si todavía no existe en el cromosoma.

\begin{code}
<pre><a name="line-379"></a>
<a name="line-380"></a>  <span class='hs-varid'>mutGenePOI</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0.01</span><span class='hs-layout'>,</span> <span class='hs-varid'>mutGenePOI'</span><span class='hs-layout'>)</span>
<a name="line-381"></a>  <span class='hs-varid'>mutGenePOI'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutateGene</span>
<a name="line-382"></a>  <span class='hs-varid'>mutGenePOI'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>ch</span> <span class='hs-varid'>gene</span>  <span class='hs-keyglyph'>=</span>    <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>gene</span>
<a name="line-383"></a>                          <span class='hs-varop'>&lt;$&gt;</span>  <span class='hs-varid'>randChoiceSafe</span> <span class='hs-varid'>notFound</span>
<a name="line-384"></a>        <span class='hs-keyword'>where</span>  <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gaLabyri</span> <span class='hs-varid'>ga</span>
<a name="line-385"></a>               <span class='hs-varid'>notFound</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>ch</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>labyrinthPOIs</span> <span class='hs-varid'>l</span>
<a name="line-386"></a>
</pre>\end{code}

  \item[$P=0.005$ ---] Cambia un gen a un aleatorio.

\begin{code}
<pre><a name="line-387"></a>
<a name="line-388"></a>  <span class='hs-varid'>mutGeneAny</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0.005</span><span class='hs-layout'>,</span> <span class='hs-varid'>mutGeneAny'</span><span class='hs-layout'>)</span>
<a name="line-389"></a>  <span class='hs-varid'>mutGeneAny'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutateGene</span>
<a name="line-390"></a>  <span class='hs-varid'>mutGeneAny'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>chrom</span> <span class='hs-varid'>gene</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-391"></a>        <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStdGen</span>
<a name="line-392"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>gene'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaLabyri</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-varid'>chrom</span> <span class='hs-varid'>gen</span>
<a name="line-393"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>gene'</span>
<a name="line-394"></a>
</pre>\end{code}

\end{itemize}

\noindent La aplicación de las mutaciones se encuentra en subsección \ref{subsec:ga}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Algoritmo genético}
\label{subsec:ga}

\begin{code}
<pre><a name="line-395"></a>
<a name="line-396"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>GAParams</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GAParams</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>gaChromGenMaxChainLen</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-397"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaChromGenMaxChains</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-398"></a>
<a name="line-399"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaMutateMaxChainsGen</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-400"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaMutateMaxChainLen</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-401"></a>
<a name="line-402"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaMaxUnchangedIter</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-403"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaMaxIters</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-404"></a>
<a name="line-405"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaSelIntactFrac</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rational</span>
<a name="line-406"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaSelCrossoverFrac</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rational</span>
<a name="line-407"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>gaSelMutateFrac</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rational</span>
<a name="line-408"></a>    <span class='hs-layout'>}</span>
<a name="line-409"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-410"></a>
<a name="line-411"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>GACache</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GACache</span> <span class='hs-layout'>{</span>
<a name="line-412"></a>        <span class='hs-varid'>cacheNeighbours</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Point2D</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-413"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>cacheBestRepeats</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span>
<a name="line-414"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>cacheBestFitness</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>RouteFitness</span><span class='hs-layout'>)</span>
<a name="line-415"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>cacheIter</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span>
<a name="line-416"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>cacheSelIndexGen</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-417"></a>    <span class='hs-layout'>}</span>
<a name="line-418"></a>
<a name="line-419"></a>  <span class='hs-varid'>cachedBestFit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GACache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>RouteFitness</span><span class='hs-layout'>)</span>
<a name="line-420"></a>  <span class='hs-varid'>cachedBestFit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheBestFitness</span>
<a name="line-421"></a>
<a name="line-422"></a>  <span class='hs-varid'>setCachedBestFit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheBestFitness</span>
<a name="line-423"></a>
<a name="line-424"></a>  <span class='hs-varid'>cachedRepeat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheBestRepeats</span>
<a name="line-425"></a>  <span class='hs-varid'>affectCachedRepeat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheBestRepeats</span>
<a name="line-426"></a>
<a name="line-427"></a>  <span class='hs-varid'>cachedIter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheIter</span>
<a name="line-428"></a>  <span class='hs-varid'>affectCachedIter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheIter</span>
<a name="line-429"></a>
<a name="line-430"></a>  <span class='hs-varid'>cachedIdxGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheSelIndexGen</span>
<a name="line-431"></a>  <span class='hs-varid'>setCachedIdxGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cacheSelIndexGen</span>
<a name="line-432"></a>
<a name="line-433"></a>  <span class='hs-varid'>neighboursOf</span> <span class='hs-varid'>cache</span> <span class='hs-varid'>point</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-conid'>[]</span>
<a name="line-434"></a>                           <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>point</span> <span class='hs-layout'>(</span><span class='hs-varid'>cacheNeighbours</span> <span class='hs-varid'>cache</span><span class='hs-layout'>)</span>
<a name="line-435"></a>
<a name="line-436"></a>  <span class='hs-keyword'>data</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GA</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>gaLabyri</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Labyrinth2D</span>
<a name="line-437"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>gaParams</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GAParams</span>
<a name="line-438"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>gaCache</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GACache</span>
<a name="line-439"></a>                <span class='hs-layout'>}</span>
</pre>\end{code}



\noindent
Se define la métrica sobre los puntos del grafo:
$$
  \mathrm{dist}(p_1, p_2) = \begin{cases}
       \mathit{Just}~ d_E(p_1, p_2)
    &  \mbox{si } \exists \text{ arista, conectando } p_1 \text{ y } p_2
    \\ \mathit{Nothing}
    &  \mbox{en otro caso}
  \end{cases}
\text {, donde}

d_E \text{ --- es la distancia euclidiana entre dos puntos.}
$$


\begin{code}
<pre><a name="line-440"></a>  <span class='hs-varid'>eDist'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDirectDistance</span> <span class='hs-varop'>$</span>
<a name="line-441"></a>          <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Point2D</span> <span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-layout'>,</span><span class='hs-varid'>x2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Point2D</span> <span class='hs-layout'>(</span><span class='hs-varid'>y1</span><span class='hs-layout'>,</span><span class='hs-varid'>y2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-442"></a>                    <span class='hs-varid'>sqrt</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>abs</span><span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-comment'>-</span><span class='hs-varid'>x2</span><span class='hs-layout'>)</span><span class='hs-varop'>^</span><span class='hs-num'>2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>abs</span><span class='hs-layout'>(</span><span class='hs-varid'>y1</span><span class='hs-comment'>-</span><span class='hs-varid'>y2</span><span class='hs-layout'>)</span><span class='hs-varop'>^</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-443"></a>  <span class='hs-varid'>eDist</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>labyrinthDist</span> <span class='hs-varid'>eDist'</span>
</pre>\end{code}

\crule{1}
\medskip
\noindent
Se define la instancia de la clase \emph{GeneticAlgorithm} para \emph{GA}
empezando con los tipos y siguiendo con los métodos.

<pre><a name="line-444"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>instance</span> <span class='hs-conid'>GeneticAlgorithm</span> <span class='hs-conid'>GA</span> <span class='hs-keyword'>where</span>
</pre>
\begin{enumerate}[(1)]

\item Un \emph{gen} se define como \underline{nodo del laberinto}
      y un \emph{cromosoma} como una \underline{lista de genes}.

      Los cromosomas no deben de tener repeticiones.

<pre><a name="line-445"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>Gene</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Point2D</span>
<a name="line-446"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>Chromosome</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span>
<a name="line-447"></a><span class='hs-varop'>&gt;</span>    <span class='hs-comment'>-- listGenes :: Chromosome ga \rightarrow$ [Gene ga]</span>
<a name="line-448"></a><span class='hs-varop'>&gt;</span>    <span class='hs-varid'>listGenes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
</pre>
\item Los valores de aptitud ya fueron descritos previamente.

<pre><a name="line-449"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>Fitness</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RouteFitness</span>
</pre>
\item Dirección de búsqueda -- minimización.

<pre><a name="line-450"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>Target</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Min</span>
</pre>
\item Información de entrada para generación de la población --- el laberinto y los parámetros.

<pre><a name="line-451"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>InputData</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Labyrinth2D</span><span class='hs-layout'>,</span> <span class='hs-conid'>GAParams</span><span class='hs-layout'>)</span>
</pre>
\item El resultado es el \underline{mejor cromosoma} obtenido.

<pre><a name="line-452"></a><span class='hs-varop'>&gt;</span>    <span class='hs-keyword'>type</span> <span class='hs-conid'>ResultData</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Chromosome</span> <span class='hs-conid'>GA</span>
</pre>

%%%%%%%%%%%%%%%%%%%%%   %%%%%%%%%%%%%%%%%%%%

\item La \textbf{aptitud de adaptación} fue descrita en subsección \ref{subsec:fitness}.

\begin{code}
<pre><a name="line-453"></a>     <span class='hs-comment'>-- fitness :: ga \rightarrow$ Chromosome ga \rightarrow$ Fitness ga</span>
<a name="line-454"></a>     <span class='hs-varid'>fitness</span> <span class='hs-layout'>(</span><span class='hs-conid'>GA</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>genes</span> <span class='hs-keyglyph'>=</span>
<a name="line-455"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>dists</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eDist</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lPairs</span> <span class='hs-varid'>genes</span><span class='hs-layout'>)</span>
<a name="line-456"></a>                    <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>`all`</span> <span class='hs-varid'>dists</span>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>l</span>  <span class='hs-varop'>`elem`</span> <span class='hs-varid'>genes</span>
<a name="line-457"></a>                                              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>target</span>  <span class='hs-varid'>l</span>  <span class='hs-varop'>`elem`</span> <span class='hs-varid'>genes</span>
<a name="line-458"></a>                         <span class='hs-keyword'>then</span> <span class='hs-comment'>-- is a valid route</span>
<a name="line-459"></a>                              <span class='hs-conid'>CompleteRoute</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromJust</span> <span class='hs-varid'>dists</span>
<a name="line-460"></a>                         <span class='hs-keyword'>else</span> <span class='hs-comment'>-- is incomplete</span>
<a name="line-461"></a>                              <span class='hs-keyword'>let</span> <span class='hs-varid'>valid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>dists</span>
<a name="line-462"></a>                                  <span class='hs-varid'>plen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>dists</span>
<a name="line-463"></a>                                  <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>valid</span><span class='hs-layout'>)</span>
<a name="line-464"></a>                                     <span class='hs-varop'>/</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>plen</span>
<a name="line-465"></a>                                  <span class='hs-varid'>hasInit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elem</span> <span class='hs-layout'>(</span><span class='hs-varid'>initial</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>genes</span>
<a name="line-466"></a>                                  <span class='hs-varid'>hasFin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elem</span> <span class='hs-layout'>(</span><span class='hs-varid'>target</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>genes</span>
<a name="line-467"></a>                                  <span class='hs-varid'>poi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasInit</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasFin</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-468"></a>                                          <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POIBoth</span>
<a name="line-469"></a>                                          <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POISome</span> <span class='hs-conid'>POIInit</span>
<a name="line-470"></a>                                          <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POISome</span> <span class='hs-conid'>POITarget</span>
<a name="line-471"></a>                                          <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POINone</span>
<a name="line-472"></a>                                  <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromJust</span> <span class='hs-varid'>valid</span>
<a name="line-473"></a>                                  <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNaN</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>v</span>
<a name="line-474"></a>                                  <span class='hs-keyword'>in</span> <span class='hs-conid'>PartialRoute</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>poi</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>len</span>
<a name="line-475"></a>
</pre>\end{code}


%%%%%%%%%%%%%%%%%%%%%   %%%%%%%%%%%%%%%%%%%%

\item Generación de cromosomas aleatorios.

<pre><a name="line-476"></a><span class='hs-varop'>&gt;</span>    <span class='hs-comment'>-- randomChromosome :: ga \rightarrow$ IO (Chromosome ga)</span>
<a name="line-477"></a><span class='hs-varop'>&gt;</span>    <span class='hs-varid'>randomChromosome</span> <span class='hs-varid'>ga</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GA</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>params</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
</pre>
Se selecciona aleatoriamente la longetud de \emph{cadenas}.

<pre><a name="line-478"></a><span class='hs-varop'>&gt;</span>       <span class='hs-varid'>chainLen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomRIO</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>gaChromGenMaxChainLen</span> <span class='hs-varid'>params</span><span class='hs-layout'>)</span>
</pre>
Se selecciona aleatoriamente el número de \emph{cadenas}.

<pre><a name="line-479"></a><span class='hs-varop'>&gt;</span>       <span class='hs-varid'>chainCnt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomRIO</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>gaChromGenMaxChains</span> <span class='hs-varid'>params</span><span class='hs-layout'>)</span>
</pre>
Se genera el cromosoma.

\begin{code}
<pre><a name="line-480"></a>        <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStdGen</span>
<a name="line-481"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randChain</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>g</span> <span class='hs-varid'>chainLen</span>
<a name="line-482"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>chainCnt</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


%%%%%%%%%%%%%%%%%%%%%   %%%%%%%%%%%%%%%%%%%%


\item La \emph{recombinación} de cromosomas se enfoca en remplazar las
      malas sub-rutas o extender rutas existentes.



\begin{code}
<pre><a name="line-483"></a>
<a name="line-484"></a>     <span class='hs-keyword'>type</span> <span class='hs-conid'>CrossoverDebug</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span>  <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubRoutes</span><span class='hs-keyglyph'>]</span>
<a name="line-485"></a>                               <span class='hs-layout'>,</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ReplaceDebug</span><span class='hs-layout'>,</span>  <span class='hs-conid'>ExtendDebug</span><span class='hs-layout'>)</span>
<a name="line-486"></a>                               <span class='hs-layout'>)</span>
<a name="line-487"></a>
<a name="line-488"></a>     <span class='hs-comment'>-- crossover' :: ga \rightarrow$ Chromosome ga \rightarrow$ Chromosome ga</span>
<a name="line-489"></a>     <span class='hs-comment'>-- \rightarrow$ ((Chromosome ga, Chromosome ga), CrossoverDebug ga)</span>
<a name="line-490"></a>
<a name="line-491"></a>     <span class='hs-varid'>crossover'</span> <span class='hs-layout'>(</span><span class='hs-conid'>GA</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ch1</span> <span class='hs-varid'>ch2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extended</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugs</span><span class='hs-layout'>)</span>
<a name="line-492"></a>        <span class='hs-keyword'>where</span>   <span class='hs-varid'>debugs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subRoutes</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugAcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>extDebug</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-493"></a>
<a name="line-494"></a>                <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>samePoints</span> <span class='hs-varid'>ch1</span> <span class='hs-varid'>ch2</span>
<a name="line-495"></a>                <span class='hs-varid'>sRoutes'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cs</span>
<a name="line-496"></a>                                <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cs</span>
<a name="line-497"></a>                                <span class='hs-keyword'>let</span> <span class='hs-varid'>sr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubRoute</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-498"></a>                                <span class='hs-keyword'>if</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>[]</span>
<a name="line-499"></a>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>subRoutesIn</span> <span class='hs-varid'>l</span> <span class='hs-varid'>sr</span> <span class='hs-varid'>ch1</span> <span class='hs-varid'>ch2</span>
<a name="line-500"></a>
<a name="line-501"></a>                <span class='hs-varid'>subRoutes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortWith</span> <span class='hs-conid'>Down</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sRoutes'</span>
<a name="line-502"></a>
<a name="line-503"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>replaced1</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugAcc'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryReplace</span>  <span class='hs-varid'>ch1</span>
<a name="line-504"></a>                                                     <span class='hs-varid'>isLeft</span>
<a name="line-505"></a>                                                     <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-506"></a>                                                     <span class='hs-varid'>subRoutes</span>
<a name="line-507"></a>                                                     <span class='hs-conid'>[]</span>
<a name="line-508"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>replaced2</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugAcc</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryReplace</span>  <span class='hs-varid'>ch2</span>
<a name="line-509"></a>                                                     <span class='hs-varid'>isRight</span>
<a name="line-510"></a>                                                     <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-511"></a>                                                     <span class='hs-varid'>subRoutes</span>
<a name="line-512"></a>                                                     <span class='hs-varid'>debugAcc'</span>
<a name="line-513"></a>
<a name="line-514"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>extended1</span><span class='hs-layout'>,</span> <span class='hs-varid'>extDebug1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryExtend</span> <span class='hs-varid'>l</span> <span class='hs-varid'>replaced2</span> <span class='hs-varid'>replaced1</span>
<a name="line-515"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>extended2</span><span class='hs-layout'>,</span> <span class='hs-varid'>extDebug2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryExtend</span> <span class='hs-varid'>l</span> <span class='hs-varid'>replaced1</span> <span class='hs-varid'>replaced2</span>
<a name="line-516"></a>
<a name="line-517"></a>                <span class='hs-varid'>extDebug</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extDebug1</span><span class='hs-layout'>,</span> <span class='hs-varid'>extDebug2</span><span class='hs-layout'>)</span>
<a name="line-518"></a>                <span class='hs-varid'>extended</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extended1</span><span class='hs-layout'>,</span> <span class='hs-varid'>extended2</span><span class='hs-layout'>)</span>
<a name="line-519"></a>
</pre>\end{code}


%%%%%%%%%%%%%%%%%%%%%   %%%%%%%%%%%%%%%%%%%%


\item La \emph{mutación} funciona de la siguiente manera:
      \begin{enumerate}
        \item Se escoge y se aplica una de las \emph{operaciones sobre sub-rutas}.
        \item Para cada gen del resultado del punto previo,
              se aplican (todas) las \emph{operaciones sobre genes},
              con su probabilidad asignada.
      \end{enumerate}

\begin{code}
<pre><a name="line-520"></a>
<a name="line-521"></a>     <span class='hs-comment'>-- mutate :: ga \rightarrow$ Chromosome ga \rightarrow$ IO (Chromosome ga)</span>
<a name="line-522"></a>     <span class='hs-varid'>mutate</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>chrom</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-523"></a>        <span class='hs-varid'>mutateGenes</span> <span class='hs-varid'>chrom</span> <span class='hs-varid'>geneMuts</span>
<a name="line-524"></a>
<a name="line-525"></a>        <span class='hs-keyword'>where</span>  <span class='hs-varid'>subRouteMuts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-comment'>-- TODO: disabled</span>
<a name="line-526"></a>               <span class='hs-varid'>geneMuts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mutGenePOI</span><span class='hs-layout'>,</span> <span class='hs-varid'>mutGeneAny</span> <span class='hs-keyglyph'>]</span>
<a name="line-527"></a>
<a name="line-528"></a>               <span class='hs-varid'>mutateGenes</span> <span class='hs-varid'>ch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mutateGenes'</span> <span class='hs-varid'>ch</span> <span class='hs-conid'>[]</span>
<a name="line-529"></a>               <span class='hs-varid'>mutateGenes'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>mutated</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>mutated</span>
<a name="line-530"></a>               <span class='hs-varid'>mutateGenes'</span> <span class='hs-layout'>(</span><span class='hs-varid'>gene</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>mutated</span> <span class='hs-varid'>muts</span> <span class='hs-keyglyph'>=</span>
<a name="line-531"></a>                    <span class='hs-keyword'>do</span>  <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gene'</span>
<a name="line-532"></a>                        <span class='hs-varid'>mutateGenes'</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>mutated</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>g</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>muts</span>
<a name="line-533"></a>
<a name="line-534"></a>                    <span class='hs-keyword'>where</span>  <span class='hs-comment'>-- chrom g = mutated ++ g:t</span>
<a name="line-535"></a>                           <span class='hs-varid'>mutF</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>mut</span><span class='hs-layout'>)</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-536"></a>                                 <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Double</span>
<a name="line-537"></a>                                 <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>g'</span>
<a name="line-538"></a>                                 <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mut</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>mutated</span> <span class='hs-varid'>g</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>g</span>
<a name="line-539"></a>                           <span class='hs-varid'>gene'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mutF</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>gene</span><span class='hs-layout'>)</span> <span class='hs-varid'>muts</span>
<a name="line-540"></a>
<a name="line-541"></a>
<a name="line-542"></a>
</pre>\end{code}


\item \emph{Criterio de parada} se selecciona, considerando que no
  se conoce la longitud de ruta aceptable.
  Esto no permite establecer un criterio exacto.

  Es porque el criterio se establece sobre el
  \emph{cambio del mejor valor de adaptación en las últimas iteraciones}.

  \noindent También se utiliza como criterio adicional el \emph{número máximo de iteraciones}.

\begin{code}
<pre><a name="line-543"></a>     <span class='hs-comment'>-- stopCriteria :: ga \rightarrow$ [Fitness ga] \rightarrow$ IO Bool</span>
<a name="line-544"></a>     <span class='hs-varid'>stopCriteria</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>fitness</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-545"></a>            <span class='hs-keyword'>let</span>  <span class='hs-varid'>cache</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span>
<a name="line-546"></a>                 <span class='hs-varid'>raiseCount</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cache</span> <span class='hs-varop'>`affectCachedRepeat`</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-547"></a>
<a name="line-548"></a>                 <span class='hs-varid'>best</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>fitness</span>
<a name="line-549"></a>            <span class='hs-varid'>best'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cachedBestFit</span> <span class='hs-varid'>cache</span>
<a name="line-550"></a>
<a name="line-551"></a>            <span class='hs-keyword'>if</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>best</span> <span class='hs-varop'>==</span> <span class='hs-varid'>best'</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>raiseCount</span>
<a name="line-552"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>cache</span> <span class='hs-varop'>`setCachedBestFit`</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>best</span>
<a name="line-553"></a>
<a name="line-554"></a>            <span class='hs-varid'>repCount</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cachedRepeat</span> <span class='hs-varid'>cache</span>
<a name="line-555"></a>            <span class='hs-varid'>iter</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cachedIter</span> <span class='hs-varid'>cache</span>
<a name="line-556"></a>
<a name="line-557"></a>            <span class='hs-varid'>return</span>  <span class='hs-varop'>$</span>   <span class='hs-varid'>repCount</span>  <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>gaMaxUnchangedIter</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaParams</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span>
<a name="line-558"></a>                    <span class='hs-varop'>||</span>  <span class='hs-varid'>iter</span>      <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>gaMaxIters</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaParams</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span>
<a name="line-559"></a>
</pre>\end{code}


\item Creación de instancia de \emph{GA}. Se crea el cache.

\begin{code}
<pre><a name="line-560"></a>
<a name="line-561"></a>     <span class='hs-comment'>-- newGA :: InputData ga \rightarrow$ IO ga</span>
<a name="line-562"></a>     <span class='hs-varid'>newGA</span> <span class='hs-layout'>(</span><span class='hs-varid'>labyrinth</span><span class='hs-layout'>,</span> <span class='hs-varid'>params</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-563"></a>        <span class='hs-keyword'>let</span>  <span class='hs-varid'>nodes'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nodes</span> <span class='hs-varid'>labyrinth</span>
<a name="line-564"></a>
<a name="line-565"></a>             <span class='hs-varid'>neighbours</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-566"></a>                <span class='hs-varid'>node</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nodes'</span>
<a name="line-567"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>connected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`edgeOf`</span> <span class='hs-varid'>labyrinth</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-conid'>(,)</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-varid'>nodes'</span>
<a name="line-568"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>connected</span><span class='hs-layout'>)</span>
<a name="line-569"></a>
<a name="line-570"></a>        <span class='hs-varid'>bestRepeats</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-num'>0</span>
<a name="line-571"></a>        <span class='hs-varid'>bestFitness</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>Nothing</span>
<a name="line-572"></a>        <span class='hs-varid'>iter</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-num'>0</span>
<a name="line-573"></a>        <span class='hs-varid'>selIndexGen</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-574"></a>
<a name="line-575"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GACache</span>  <span class='hs-varid'>neighbours</span>
<a name="line-576"></a>                             <span class='hs-varid'>bestRepeats</span>
<a name="line-577"></a>                             <span class='hs-varid'>bestFitness</span>
<a name="line-578"></a>                             <span class='hs-varid'>iter</span>
<a name="line-579"></a>                             <span class='hs-varid'>selIndexGen</span>
<a name="line-580"></a>
<a name="line-581"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GA</span> <span class='hs-varid'>labyrinth</span> <span class='hs-varid'>params</span> <span class='hs-varid'>cache</span>
<a name="line-582"></a>
</pre>\end{code}

\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Implementación III}

El proyecto separa las operaciones genéticas \emph{atómicas}, definidas en clase \emph{GA},
de las \emph{masivas}, definidas en clase \emph{RunGA}.

Las operaciones \emph{masivas} -- son las que trabajan con entera población:
\begin{enumerate*}[1)]
  \item selección de cromosomas para operaciones genéticas, generación de población inicial;
  \item generación de población inicial;
  \item ejecución de las iteraciones.
\end{enumerate*}

Las últimas dos están definidas en \hssrc{GeneticAlgorithm}{GeneticAlgorithm},
pero su código se presentara incluso en subsección \ref{subsec:gaRun}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{ Operaciones de selección }
\label{subsec:gaSelect}

Para preservar el tamaño de población, la unión de las tres
siguientes selecciones debe siempre ser de mismo tamaño que la población,
de la cual hubieron sidos seleccionados.

Se usa un concepto \emph{Assessed}, el cual encapsula una lista de
cromosomas con sus correspondientes valores de adaptación.
Está siempre ordenada ascendentemente, para que los mejores
cromosomas (con menor valor de adaptación) estén en el principio.

Se intentaba usar \emph{RouteFitness} sin transformarlos en un valor numérico;
para esto se define la función de densidad de probabilidad de selección
de un cromosoma, dependiendo de su índice en la lista.

\begin{align*}
  P'_i &= \dfrac{0.1}{i} \\
  P_i  &= \dfrac{P'_i}{ \sum\limits_j P'_j }
\end{align*}

\begin{tikzpicture}
  \edef\N{200}

  \draw[->] (0,0) -- (10,0) node[right] {$i$};
  \draw[->] (0,0) -- (0,10) node[above] {$P'_i$};

  \foreach \x   [evaluate=\x as \i using \x*\N*0.1] in {1,2,...,10}
	\draw (\x,1pt) -- (\x,-3pt)
	node[anchor=north] {\pgfmathprintnumber[fixed,precision=0]{\i}};

  \foreach \y [evaluate=\y as \i using \y*0.01] in {0,...,10}
	\draw (1pt,\y) -- (-3pt,\y)
		node[anchor=east] {\pgfmathprintnumber[fixed,precision=3]{\i}};

  \draw[xscale=10/\N, yscale=100, domain=1:\N,variable=\x,blue]
    plot ({\x},{0.1 / \x});
\end{tikzpicture}

\bigskip

\begin{code}
<pre><a name="line-583"></a>
<a name="line-584"></a>  <span class='hs-varid'>assessedProb'</span> <span class='hs-varid'>i</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>0.1</span> <span class='hs-varop'>/</span> <span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span>
<a name="line-585"></a>
<a name="line-586"></a>  <span class='hs-varid'>assessedProbs</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>/</span> <span class='hs-varid'>isum</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>
<a name="line-587"></a>        <span class='hs-keyword'>where</span>  <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessedProb'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-588"></a>               <span class='hs-varid'>isum</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-varid'>is</span>
<a name="line-589"></a>
<a name="line-590"></a>
<a name="line-591"></a>  <span class='hs-varid'>assessedRandIndexGen</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- Population size.</span>
<a name="line-592"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Previous indices.</span>
<a name="line-593"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- Random index.</span>
<a name="line-594"></a>  <span class='hs-varid'>assessedRandIndexGen</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>randIdx</span>
<a name="line-595"></a>    <span class='hs-keyword'>where</span>  <span class='hs-varid'>probs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessedProbs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>toInteger</span> <span class='hs-varid'>n</span>
<a name="line-596"></a>           <span class='hs-comment'>-- accumulated probabilities</span>
<a name="line-597"></a>           <span class='hs-varid'>accProbs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldr</span>  <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-varop'>+</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>p'</span><span class='hs-varop'>+</span><span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-598"></a>                                   <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>probs</span>
<a name="line-599"></a>           <span class='hs-comment'>-- select id, given a number in [0,1]</span>
<a name="line-600"></a>           <span class='hs-varid'>selIdx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-601"></a>           <span class='hs-varid'>selIdx</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>let</span> <span class='hs-varid'>less</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>`filter`</span> <span class='hs-varid'>accProbs</span>
<a name="line-602"></a>                       <span class='hs-keyword'>in</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>less</span> <span class='hs-comment'>-</span><span class='hs-num'>1</span>
<a name="line-603"></a>           <span class='hs-comment'>-- Generate a random assessed index,</span>
<a name="line-604"></a>           <span class='hs-comment'>-- without repeating elems of `prev`.</span>
<a name="line-605"></a>           <span class='hs-varid'>randIdx</span> <span class='hs-varid'>prev</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-606"></a>                <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selIdx</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>randomIO</span>
<a name="line-607"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>prev</span>  <span class='hs-keyword'>then</span> <span class='hs-varid'>randIdx</span> <span class='hs-varid'>prev</span>
<a name="line-608"></a>                                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-609"></a>
<a name="line-610"></a>  <span class='hs-varid'>replicateRandIndices</span> <span class='hs-varid'>prev'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>igen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>prev'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-611"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prev</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prev</span>
<a name="line-612"></a>                            <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>igen</span> <span class='hs-varid'>p</span>
<a name="line-613"></a>                            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>i</span><span class='hs-conop'>:</span><span class='hs-varid'>p</span>
<a name="line-614"></a>
<a name="line-615"></a>  <span class='hs-varid'>assessedRand</span> <span class='hs-varid'>selFrac</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>assessed</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-616"></a>        <span class='hs-varid'>iGen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cachedIdxGen</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span>
<a name="line-617"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>pSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-varid'>popSize</span> <span class='hs-varid'>assessed</span>
<a name="line-618"></a>            <span class='hs-varid'>frac</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>selFrac</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaParams</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span>
<a name="line-619"></a>            <span class='hs-varid'>count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>round</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pSize</span> <span class='hs-varop'>*</span> <span class='hs-varid'>frac</span>
<a name="line-620"></a>
<a name="line-621"></a>        <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateRandIndices</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>count</span> <span class='hs-varid'>iGen</span> <span class='hs-comment'>--replicateM count iGen</span>
<a name="line-622"></a>
<a name="line-623"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ua</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unwrapAssessed</span> <span class='hs-varid'>assessed</span>
<a name="line-624"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ua</span> <span class='hs-varop'>!!</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-625"></a>
</pre>\end{code}

\crule{0.75}
\bigskip

\begin{code}
<pre><a name="line-626"></a>
<a name="line-627"></a>  <span class='hs-keyword'>instance</span> <span class='hs-conid'>RunGA</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>RouteFitness</span> <span class='hs-conid'>Min</span> <span class='hs-keyword'>where</span>
<a name="line-628"></a>    <span class='hs-keyword'>type</span> <span class='hs-conid'>DebugData</span> <span class='hs-conid'>GA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Assessed</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point2D</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>RouteFitness</span>
<a name="line-629"></a>
<a name="line-630"></a>
</pre>\end{code}

\noindent Se define \underline{selección de cromosomas}:
\begin{enumerate}[(a)]

  \item Que \underline{pasan a la siguiente generación intactos}.

    La fracción establecida de la población previa se escoge
    aleatoriamente (con repeticiones).

\begin{code}
<pre><a name="line-631"></a>
<a name="line-632"></a>    <span class='hs-varid'>selectIntact</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessedRand</span> <span class='hs-varid'>gaSelIntactFrac</span>
<a name="line-633"></a>
</pre>\end{code}

  \item Para la \underline{recombinación}.

        Se escoge aleatoriamente una fraccion establecida de la población previa
        y se divide en dos partes iguales.

\begin{code}
<pre><a name="line-634"></a>
<a name="line-635"></a>    <span class='hs-varid'>selectCrossover</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>assessed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>rand</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>rand</span>
<a name="line-636"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>rand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessedRand</span>  <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varop'>/</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gaSelCrossoverFrac</span><span class='hs-layout'>)</span>
<a name="line-637"></a>                                   <span class='hs-varid'>ga</span> <span class='hs-varid'>assessed</span>
<a name="line-638"></a>
</pre>\end{code}


  \item Para la \underline{mutación}.

        Se escoge aleatoriamente una fracción establecida de la población previa.

\begin{code}
<pre><a name="line-639"></a>
<a name="line-640"></a>    <span class='hs-varid'>selectMutate</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessedRand</span> <span class='hs-varid'>gaSelMutateFrac</span>
<a name="line-641"></a>
</pre>\end{code}

\end{enumerate}


\medskip
\noindent El resultado es el cromosoma con mejor valor de adaptación.

\begin{code}
<pre><a name="line-642"></a>
<a name="line-643"></a>    <span class='hs-varid'>selectResult</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Assessed</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-644"></a>
</pre>\end{code}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Ejecución de algoritmo genético}
\label{subsec:gaRun}

\noindent Se implementan las actualizaciones de cache.

\begin{code}
<pre><a name="line-645"></a>
<a name="line-646"></a>    <span class='hs-varid'>initHook</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>pop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCachedIdxGen</span>  <span class='hs-layout'>(</span><span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span>
<a name="line-647"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>assessedRandIndexGen</span> <span class='hs-varid'>pop</span><span class='hs-layout'>)</span>
<a name="line-648"></a>
<a name="line-649"></a>    <span class='hs-varid'>iterationHook</span> <span class='hs-varid'>ga</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>affectCachedIter</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-650"></a>                           <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cachedIter</span> <span class='hs-layout'>(</span><span class='hs-varid'>gaCache</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span>
<a name="line-651"></a>                           <span class='hs-varid'>putStrLn</span> <span class='hs-varop'>$</span> <span class='hs-str'>"iteration #"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>i</span>
<a name="line-652"></a>
</pre>\end{code}


\noindent Se presenta aquí una parte del código desde \hssrc{GeneticAlgorithm}{GeneticAlgorithm}.

\begin{itemize}

\item Generación de población inicial.

\begin{spec}
<pre><a name="line-653"></a>    <span class='hs-varid'>initialPopulation</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>pop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-varop'>$</span>  <span class='hs-keyword'>do</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>pop</span><span class='hs-keyglyph'>]</span>
<a name="line-654"></a>                                           <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>randomChromosome</span> <span class='hs-varid'>ga</span>
</pre>\end{spec}

\item  Ejecución de las iteraciones del algoritmo.

\begin{spec}
<pre><a name="line-655"></a>
<a name="line-656"></a><a name="runGA'"></a><span class='hs-definition'>runGA'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>pop</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-657"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assessed</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>fitness</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-varid'>pop</span>
<a name="line-658"></a>
<a name="line-659"></a>    <span class='hs-varid'>iterationHook</span> <span class='hs-varid'>ga</span>
<a name="line-660"></a>
<a name="line-661"></a>    <span class='hs-varid'>stop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stopCriteria</span> <span class='hs-varid'>ga</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unwrapAssessed</span> <span class='hs-varid'>fit</span>
<a name="line-662"></a>
<a name="line-663"></a>    <span class='hs-varid'>intact</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectIntact</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>fit</span>
<a name="line-664"></a>    <span class='hs-varid'>cross</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectCrossover</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>fit</span>
<a name="line-665"></a>    <span class='hs-varid'>mut</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectMutate</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>fit</span>
<a name="line-666"></a>
<a name="line-667"></a>
<a name="line-668"></a>    <span class='hs-varid'>mutated</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mutate</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span> <span class='hs-varid'>mut</span>
<a name="line-669"></a>
<a name="line-670"></a>    <span class='hs-keyword'>let</span>  <span class='hs-varid'>pairToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span>
<a name="line-671"></a>         <span class='hs-varid'>newPop</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>intact</span>
<a name="line-672"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>pairToList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>crossover</span> <span class='hs-varid'>ga</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cross</span>
<a name="line-673"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>mutated</span>
<a name="line-674"></a>
<a name="line-675"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>stop</span>  <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>selectResult</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>fit</span>
<a name="line-676"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>runGA'</span> <span class='hs-varid'>ga</span> <span class='hs-varid'>newPop</span>
<a name="line-677"></a>
</pre>\end{spec}

\end{itemize}






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Ejecución y Pruebas}

La aplicación está definida en \hssrc{Parcial2--App}{Parcial2/App}
y la ejecutable actual en \hssrc{Parcial2--App}{Parcial2/App}.

\noindent El modo de uso se describe en Anexo I.


El proyecto también contiene aplicación de ejemplo \texttt{ga-labyrinth-example-1}
y otras ejecutables que se usan para generación del documento.


\subsection{Pruebas}

\begin{note}
    El algoritmo considera todas las rutas que contienen inicio y meta, no solamente
    si son extremos.
\end{note}

\subsubsection{Ejemplo de tarea}

El ejemplo se lee desde archivo \emph{laby.txt}.

\begin{verbatim}
dist/build/ga-labyrinth/ga-labyrinth\
    laby.txt 200\
    --gen-max-chain-len 5\
    --gen-max-chains 1\
    -I 100 -U 20
\end{verbatim}

El resultado (sin debug):

\begin{verbatim}
  [0-0,4-3,6-2,7-21]
\end{verbatim}

\subsubsection{Ejemplo de proyecto}
El laberinto se presenta en figura \ref{fig:rawMapExample};

\begin{verbatim}
dist/build/ga-labyrinth-example-1/ga-labyrinth-example-1\
    200\
    --gen-max-chain-len 10\
    --gen-max-chains 10\
    -I 100 -U 20
\end{verbatim}

\begin{verbatim}
[9--3,8--3,8-0,4-0,3-0,1-0,1--2,0--2]
\end{verbatim}


\subsection{Cambios necesarios}

\begin{enumerate}
  \item Seleccionar al remplazamiento en la recombinación de cromosomas aleatoriamente.
        Al momento el proceso de ``crossover'' es \emph{puro} -- no causa efectos secundarios,
        a los cuales pertenece lo ``aleatorio''. Eso también quiere decir que el resultado
        siempre es el mismo para los mismos padres. Se necesita introducir mas variedad.

  \item Al momento están desactivadas las {\color{red} \emph{mutaciones sobre rutas completas}},
        porque las implementaciones quiebran la política de no-repetición de genes.
        Deben ser reescritas.

\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Proyecto}

El proyecto requiere GHC y \texttt{cabal} para construcción.

Hay una dependencia, que no está disponible públicamente, por esto se necesita instalarla a mano:
\href{https://github.com/fehu/CommandArgs}{CommandArgs}.

\crule{1}


El proyecto usa el paradigma de \emph{programación literaria} y el reporte se genera desde el código.

Los ejemplos de laberinto y cromosomas se generan usando los mecanismos del proyecto;
los de cromosomas usan función \emph{crossover} de \emph{GA}.


\noindent El reporte en pdf se genera con script \emph{makeReport} proveído.
Requiere instalación de \texttt{lhs2TeX} desde \texttt{cabal}.


\section*{Anexo I}
\label{sec:A1}

\begin{verbatim}

Searches the shortest path in a labyrinth with Genetic Algorithm.

ga-labyrinth <Labyrinth File> <Population Size> [gen-max-chains]
                                                [gen-max-chain-len]
                                                [mut-max-chains]
                                                [mut-max-chain-len]
                                                [max-unchanged]
                                                [max-iter]
                                                [frac-intact]
                                                [frac-crossover]
                                                [frac-mutation]
                                                [fracs]
                                                [help]

Positional:
  Labyrinth File :: Text 	--  path to labyrinth file
  Population Size :: Int 	--

Optional:

  gen-max-chains <value>
     --gen-max-chains
     Chromosome Generation: maximum chain number.
        value :: Int 	--

  gen-max-chain-len <value>
     --gen-max-chain-len
     Chromosome Generation: maximum chain length.
        value :: Int 	--

  mut-max-chains <value>
     --mut-max-chains
     Chromosome Mutation: maximum chains to insert.
        value :: Int 	--

  mut-max-chain-len <value>
     --mut-max-chain-len
     Chromosome Mutation: maximum insert chain length.
        value :: Int 	--

  max-unchanged <value>
     -U --max-unchanged
     Maximum number of iterations without best fitness
     change before stopping.
        value :: Int 	--

  max-iter <value>
     -I --max-iter
     Maximum number of iterations.
        value :: Int 	--

  frac-intact <value>
     --frac-intact
     Fraction of population left intact.
        value :: Float 	--

  frac-crossover <value>
     --frac-crossover
     Fraction of population used for crossover.
        value :: Float 	--

  frac-mutation <value>
     --frac-mutation
     Fraction of population used for mutation.
        value :: Float 	--

  fracs <intact> <crossover> <mutation>
     -f --fracs
     Set all the fractions at once.
        intact :: Float 	--  intact fraction
        crossover :: Float 	--  crossover fraction
        mutation :: Float 	--  mutation fraction

  help <cmd...>
     -h --help
     Show help
        cmd... :: Text 	--  Commands to show the help for


\end{verbatim}

\end{document}

</body>
</html>
